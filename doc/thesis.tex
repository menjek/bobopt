%%% Hlavní soubor. Zde se definují základní parametry a odkazuje se na ostatní části. %%%

%% Verze pro jednostranný tisk:
% Okraje: levý 40mm, pravý 25mm, horní a dolní 25mm
% (ale pozor, LaTeX si sám přidává 1in)
\documentclass[12pt,a4paper]{report}
\setlength\textwidth{145mm}
\setlength\textheight{247mm}
\setlength\oddsidemargin{15mm}
\setlength\evensidemargin{15mm}
\setlength\topmargin{0mm}
\setlength\headsep{0mm}
\setlength\headheight{0mm}
% \openright zařídí, aby následující text začínal na pravé straně knihy
\let\openright=\clearpage

%% Pokud tiskneme oboustranně:
% \documentclass[12pt,a4paper,twoside,openright]{report}
% \setlength\textwidth{145mm}
% \setlength\textheight{247mm}
% \setlength\oddsidemargin{15mm}
% \setlength\evensidemargin{0mm}
% \setlength\topmargin{0mm}
% \setlength\headsep{0mm}
% \setlength\headheight{0mm}
% \let\openright=\cleardoublepage

%% Použité kódování znaků: obvykle latin2, cp1250 nebo utf8:
\usepackage[utf8]{inputenc}

%% Ostatní balíčky
\usepackage{paralist}
\usepackage{array}
\usepackage[shellescape]{gmp}
\usepackage{graphicx}
\usepackage{amsthm}
\usepackage{enumitem}
\usepackage[table]{xcolor}
\usepackage{tikz}
\usepackage{lmodern}
\usepackage{url}
\usepackage[T1]{fontenc}
\usepackage{listings}
\usepackage{pgfplots}
\usepackage{ifpdf}
\ifpdf
  \DeclareGraphicsRule{*}{mps}{*}{}
\fi

\bibliographystyle{plain}

\lstset {
%	frame=bt,
    language=C++,
    backgroundcolor=\color{black!5},
%	backgroundcolor=\color{white},
%    numbers=left,
%    numbersep=5pt,
    basicstyle=\footnotesize\ttfamily,
    keywordstyle=\bfseries,
    aboveskip=15pt,
    belowskip=15pt,
    showstringspaces=false,
    columns=fixed,
}

%% Balíček hyperref, kterým jdou vyrábět klikací odkazy v PDF,
%% ale hlavně ho používáme k uložení metadat do PDF (včetně obsahu).
%% POZOR, nezapomeňte vyplnit jméno práce a autora.
\usepackage[unicode]{hyperref}   % Musí být za všemi ostatními balíčky
\hypersetup{pdftitle=Bobox Runtime Optimization}
\hypersetup{pdfauthor=Lukáš Krížik}
\hypersetup{pdfborder={0 0 0}}

\usepackage{epstopdf}

\usetikzlibrary{arrows,fit,positioning,calc,patterns,shapes.multipart,backgrounds} 
\tikzset{
    %Define standard arrow tip
    >=stealth',
    %Define style for boxes
    title/.style={
           text centered},
    % Define arrow style
    pil/.style={
           ->,
           thick,
           shorten <=3pt,
           shorten >=3pt,}
}

%%% Drobné úpravy stylu

% makro for code text definition
\def\code#1{\texttt{#1}}

% Tato makra přesvědčují mírně ošklivým trikem LaTeX, aby hlavičky kapitol
% sázel příčetněji a nevynechával nad nimi spoustu místa. Směle ignorujte.
\makeatletter
\def\@makechapterhead#1{
  {\parindent \z@ \raggedright \normalfont
   \Huge\bfseries \thechapter. #1
   \par\nobreak
   \vskip 20\p@
}}
\def\@makeschapterhead#1{
  {\parindent \z@ \raggedright \normalfont
   \Huge\bfseries #1
   \par\nobreak
   \vskip 20\p@
}}
\makeatother

% Toto makro definuje kapitolu, která není očíslovaná, ale je uvedena v obsahu.
\def\chapwithtoc#1{
\chapter*{#1}
\addcontentsline{toc}{chapter}{#1}
}

\begin{document}

% Trochu volnější nastavení dělení slov, než je default.
\lefthyphenmin=2
\righthyphenmin=2

%%% Titulní strana práce

\pagestyle{empty}
\begin{center}

\large

Charles University in Prague

\medskip

Faculty of Mathematics and Physics

\vfill

{\bf\Large MASTER THESIS}

\vfill

\centerline{\mbox{\includegraphics[width=60mm]{../img/logo.eps}}}

\vfill
\vspace{5mm}

{\LARGE Lukáš Krížik}

\vspace{15mm}

% Název práce přesně podle zadání
{\LARGE\bfseries Bobox Runtime Optimization}

\vfill

% Název katedry nebo ústavu, kde byla práce oficiálně zadána
% (dle Organizační struktury MFF UK)
The Department of Software Engineering

\vfill

\begin{tabular}{rl}

Supervisor of the master thesis: & RNDr. Filip Zavoral, Ph.D. \\
\noalign{\vspace{2mm}}
Study programme: & Informatics \\
\noalign{\vspace{2mm}}
Specialization: & Software Systems \\
\end{tabular}

\vfill

% Zde doplňte rok
Prague 2014

\end{center}

\newpage

%%% Následuje vevázaný list -- kopie podepsaného "Zadání diplomové práce".
%%% Toto zadání NENÍ součástí elektronické verze práce, nescanovat.

%%% Na tomto místě mohou být napsána případná poděkování (vedoucímu práce,
%%% konzultantovi, tomu, kdo zapůjčil software, literaturu apod.)

\openright

\noindent
Dedication.

\newpage

%%% Strana s čestným prohlášením k diplomové práci

\vglue 0pt plus 1fill

\noindent
I declare that I carried out this master thesis independently, and only with the cited
sources, literature and other professional sources.

\medskip\noindent
I understand that my work relates to the rights and obligations under the Act No.
121/2000 Coll., the Copyright Act, as amended, in particular the fact that the Charles
University in Prague has the right to conclude a license agreement on the use of this
work as a school work pursuant to Section 60 paragraph 1 of the Copyright Act.

\vspace{10mm}

\hbox{\hbox to 0.5\hsize{%
In ........ date ............
\hss}\hbox to 0.5\hsize{%
signature of the author
\hss}}

\vspace{20mm}
\newpage

%%% Povinná informační strana diplomové práce

\vbox to 0.5\vsize{
\setlength\parindent{0mm}
\setlength\parskip{5mm}

Název práce:
Bobox Runtime Optimization
% přesně dle zadání

Autor:
Lukáš Krížik

Katedra:  % Případně Ústav:
Katedra softwarového inženýrství
% dle Organizační struktury MFF UK

Vedoucí diplomové práce:
RNDr. Filip Zavoral, Ph.D.
% dle Organizační struktury MFF UK, případně plný název pracoviště mimo MFF UK

Abstrakt:
% abstrakt v rozsahu 80-200 slov; nejedná se však o opis zadání diplomové práce

Klíčová slova:
bobox, statická analýza kódu, optimalizace, složitost kódu, clang
% 3 až 5 klíčových slov

\vss}\nobreak\vbox to 0.49\vsize{
\setlength\parindent{0mm}
\setlength\parskip{5mm}

Title:
Bobox Runtime Optimization
% přesný překlad názvu práce v angličtině

Author:
Lukáš Krížik

Department:
The Department of Software Engineering
% dle Organizační struktury MFF UK v angličtině

Supervisor:
RNDr. Filip Zavoral, Ph.D.
% dle Organizační struktury MFF UK, případně plný název pracoviště
% mimo MFF UK v angličtině

Abstract:
% abstrakt v rozsahu 80-200 slov v angličtině; nejedná se však o překlad
% zadání diplomové práce

Keywords:
bobox, static code analysis, optimization, code complexity, clang
% 3 až 5 klíčových slov v angličtině

\vss}

\newpage

%%% Strana s automaticky generovaným obsahem diplomové práce. U matematických
%%% prací je přípustné, aby seznam tabulek a zkratek, existují-li, byl umístěn
%%% na začátku práce, místo na jejím konci.

\openright
\pagestyle{plain}
\setcounter{page}{1}
\tableofcontents

%%% Jednotlivé kapitoly práce jsou pro přehlednost uloženy v samostatných souborech
\include{preface}
\include{chap1}
\include{chap2}
\include{chap3}
\include{chap5}
\include{chap6}
\include{chap4}
\include{chap7}

% Ukázka použití některých konstrukcí LateXu (odkomentujte, chcete-li)
% \include{example}

\include{epilog}

%%% Seznam použité literatury
\include{bibliography}

%%% Obrázky
\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{\listfigurename}
\listoffigures

%%% Kód
\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{Listings}
\lstlistoflistings

%%% Skratky
\chapwithtoc{List of Abbreviations}
\begin{tabular}{m{1.5cm} l}
\textbf{API} & application programming interface \\
\textbf{AST} & abstract syntax tree \\
\textbf{CFG} & control flow graph \\
\textbf{CR} & carriage return \\
\textbf{CRTP} & curiously recurring template pattern \\
\textbf{DT} & derivation tree \\
\textbf{GCC} & GNU compiler collection \\
\textbf{JSON} & JavaScript object nation\\
\textbf{LF} & line feed \\
\textbf{PT} & parse tree \\
\textbf{PGO} & profile guided optimization \\
\textbf{RAII} & resource acquisition is initialization \\
\textbf{SIMD} & singe instruction, multiple data \\
\end{tabular}

%%% Přílohy k diplomové práci, existují-li (různé dodatky jako výpisy programů,
%%% diagramy apod.). Každá příloha musí být alespoň jednou odkazována z vlastního
%%% textu práce. Přílohy se číslují.
\chapwithtoc{Appendix}
\section{Output of prefetch method}
Diagnostic of prefetch method outputs information only if there is anything to optimize and optimizer is not in \emph{build} mode. Firstly, method introduce itself and points out to box definition in source code.

{\footnotesize
\begin{verbatim}
[prefetch] optimization of box merge_box
boxes.hpp:55:7: info: declared here:
class merge_box : public bobox::basic_box {
      ^~~~~~~~~
\end{verbatim}
}

Then, for every input that can be optimized by prefetch call, there is message pointing to helper macro, name of the input, and list of likely to be used locations in source code in form of member function calls on variable.

{\footnotesize
\begin{verbatim}
boxes.hpp:60:24: info: missing prefetch for input declared here:
BOBOX_BOX_INPUTS_LIST(left,0, right,1);
                      ^~~~
boxes.hpp:99:11: info: used here:
left.eof() && !right.eof()) {
^~~~~~~~~
boxes.hpp:112:11: info: used here:
left.eof()) {
^~~~~~~~~
\end{verbatim}
}

Message with optimization suggestion looks different for case when there is \code{init\_impl} overridden in optimized box or case when it is not. If there is overridden initialization function, it points to its location and suggests adding prefetch call.

{\footnotesize
\begin{verbatim}
boxes.hpp:68:18: suggestion: prefetch input in init:
virtual void init_impl();
             ^~~~~~~~~
\end{verbatim}
}

If there is no initialization function, optimizer suggests to override it together with prefetch calls.

{\footnotesize
\begin{verbatim}
boxes.hpp:55:7: suggestion: override init_impl() in box with
prefetch call(s):
class merge_box : public bobox::basic_box {
      ^~~~~~~~~
\end{verbatim}
}

Output described above is common for \emph{diagnostic} and \emph{interactive} modes. Interactive mode additionally asks user with yes/no type question whether he wants optimizer to execute suggestion and transform code. If there is at least one positive answer, transformation is applied. In \emph{build} mode there are no questions and transformation is always applied.

\section{Output of yield complex method}
Diagnostic and interactive mode are verbose modes with equivalent diagnostic output. The problematic part is diagnostic output itself. Unfortunately, I could not figure out how to display optimizer reasoning behind suggestions. The result is that diagnostic shows only suggestions with information where to put yield member call expression.

{\footnotesize
\begin{verbatim}
[yield complex] optimization of box merge_box

boxes.hpp:70:18: info: method takes too long time on some paths:
virtual void sync_mach_etwas() BOBOX_OVERRIDE
             ^~~~~~~~~~~~~~~
boxes.hpp:87:9: suggestion: placing yield() call just before
statement:
for (int l = 0; l < 100; ++l)
^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\end{verbatim}
}

It is up to programmer to lookup place in code and investigate why previous code is complex and why it is worth to yield execution. In interactive mode, there is yes/no type of question whether user wants to let optimizer update code immediately. Chosen answer obviously does not affect next algorithm work since it only allows user to select suggestions from already pre-calculated result. Algorithm already finished its work.

\openright
\end{document}
